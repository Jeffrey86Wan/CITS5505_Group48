{% extends "components/dashboard_base.html" %} {% block title %}QuickNote - Transaction History{% endblock %} {% block dashboard_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">Transaction History</h2>

        <div class="flex items-center space-x-4">
            <!-- Category selection -->
            <div class="bg-gray-50 rounded-lg p-1">
                <button id="filter-all" class="py-2 px-4 rounded-md bg-primary text-white font-medium focus:outline-none" onclick="filterTransactionType('all')">All</button>
                <button id="filter-expense" class="py-2 px-4 rounded-md text-gray-700 font-medium hover:bg-gray-100 focus:outline-none" onclick="filterTransactionType('expense')">Expenses</button>
                <button id="filter-income" class="py-2 px-4 rounded-md text-gray-700 font-medium hover:bg-gray-100 focus:outline-none" onclick="filterTransactionType('income')">Income</button>
            </div>

            <!-- Filter and export buttons -->
            <button id="filter-btn" class="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none" onclick="toggleFilterModal()">
                <i class="fas fa-filter"></i>
                <span class="ml-1">Date Filter</span>
            </button>
            <button class="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none">
                <i class="fas fa-file-export"></i>
                <span class="ml-1">Export</span>
            </button>
        </div>
    </div>

    <!-- Current filter display area -->
    <div id="active-filters" class="hidden bg-gray-50 p-3 rounded-lg">
        <div class="flex justify-between items-center">
            <div class="flex gap-2 flex-wrap items-center">
                <span class="text-sm text-gray-700">Current filters:</span>
                <span id="date-filter-badge" class="hidden py-1 px-3 bg-blue-50 text-blue-600 rounded-full text-xs font-medium"></span>
                <span id="type-filter-badge" class="hidden py-1 px-3 bg-green-50 text-green-600 rounded-full text-xs font-medium"></span>
            </div>
            <button onclick="clearAllFilters()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
                <i class="fas fa-times-circle mr-1"></i>
                Clear filters
            </button>
        </div>
    </div>

    <!-- Transaction table -->
    <div class="bg-white rounded-lg overflow-hidden border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for transaction in transactions %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ transaction.date }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-full flex items-center justify-center mr-3 bg-gray-100" style="background-color: '{{ transaction.category.color or '#F3F4F6' }}'">
                                <i class="fas {{ transaction.category.icon }} text-gray-500"></i>
                            </div>
                            <span class="text-gray-700">{{ transaction.category.name }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ transaction.description or '' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if transaction.type == 'expense' %}text-red-600{% else %}text-green-600{% endif %}">
                        {% if transaction.type == 'expense' %}-{% else %}+{% endif %}Â¥{{ transaction.amount }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="openEditModal('{{ transaction.id }}')" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDelete('{{ transaction.id }}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center">
        <div class="text-sm text-gray-500">
            {% set end_item = (page * per_page) if (page * per_page) < total_count else total_count %} Showing {{ (page - 1) * per_page + 1 if total_count > 0 else 0 }} to {{ end_item }} of {{ total_count }} entries
        </div>
        <div class="flex space-x-2">
            <a
                href="{{ url_for('flow.index', page=page-1, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), type=request.args.get('type')) if page > 1 else '#' }}"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 {% if page <= 1 %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}"
            >
                Previous
            </a>
            <span class="px-4 py-2 border border-primary bg-primary text-white rounded-md">{{ page }}</span>
            <a
                href="{{ url_for('flow.index', page=page+1, start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), type=request.args.get('type')) if page < total_pages else '#' }}"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 {% if page >= total_pages %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}"
            >
                Next
            </a>
        </div>
    </div>
</div>

<!-- Date filter modal -->
<div id="filterModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50" onclick="toggleFilterModal()"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full z-10 relative overflow-hidden">
        <div class="border-b border-gray-200">
            <div class="flex justify-between items-center p-5">
                <h3 class="text-lg font-bold text-gray-800">Date Filter</h3>
                <button onclick="toggleFilterModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="p-5">
            <form id="filterForm">
                <div class="space-y-5">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Start Date</label>
                        <input type="date" id="start_date" name="start_date" class="form-input py-3 w-full border-gray-300 rounded-lg focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-20" />
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">End Date</label>
                        <input type="date" id="end_date" name="end_date" class="form-input py-3 w-full border-gray-300 rounded-lg focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-20" />
                    </div>
                </div>

                <div class="mt-6 pt-5 border-t border-gray-200 flex justify-end space-x-3">
                    <button
                        type="button"
                        onclick="clearDateFilter()"
                        class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-opacity-50 transition-colors"
                    >
                        Clear
                    </button>
                    <button type="button" onclick="applyDateFilter()" class="px-5 py-2.5 bg-primary text-white rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-colors">
                        Apply Filter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit transaction modal -->
<div id="editModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full z-10 relative overflow-hidden">
        <div class="border-b border-gray-200">
            <div class="flex justify-between items-center p-5">
                <h3 class="text-lg font-bold text-gray-800">Edit Transaction Record</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <form id="editForm" method="POST" class="p-5">
            <input type="hidden" id="edit_transaction_id" name="transaction_id" />

            <div class="space-y-5">
                <!-- Transaction type -->
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Transaction Type</label>
                    <div class="flex space-x-4 mb-2">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="type" value="expense" class="form-radio text-primary focus:ring-primary" />
                            <span class="ml-2 text-gray-700">Expense</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="type" value="income" class="form-radio text-primary focus:ring-primary" />
                            <span class="ml-2 text-gray-700">Income</span>
                        </label>
                    </div>
                </div>

                <!-- Amount -->
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">Â¥</span>
                        <input type="number" name="amount" step="0.01" class="form-input pl-8 py-3 w-full border-gray-300 rounded-lg focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-20" placeholder="0.00" required />
                    </div>
                </div>

                <!-- Date -->
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Date</label>
                    <input type="date" name="date" class="form-input py-3 w-full border-gray-300 rounded-lg focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-20" required />
                </div>

                <!-- Category -->
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Category</label>
                    <select name="category_id" class="form-select py-3 w-full border-gray-300 rounded-lg focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-20" required>
                        <option value="">Select Category</option>
                        <!-- Category options will be populated via JavaScript -->
                    </select>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Description</label>
                    <input type="text" name="description" class="form-input py-3 w-full border-gray-300 rounded-lg focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-20" placeholder="Add a short description..." />
                </div>
            </div>

            <div class="mt-6 pt-5 border-t border-gray-200 flex justify-end space-x-3">
                <button
                    type="button"
                    onclick="closeEditModal()"
                    class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-opacity-50 transition-colors"
                >
                    Cancel
                </button>
                <button type="submit" class="px-5 py-2.5 bg-primary text-white rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-colors">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete confirmation modal -->
<div id="deleteModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full z-10 relative overflow-hidden">
        <div class="p-5 border-b border-gray-200">
            <h3 class="text-lg font-bold text-gray-800">Confirm Deletion</h3>
        </div>

        <div class="p-5">
            <p class="text-gray-600">Are you sure you want to delete this transaction record? This action cannot be undone.</p>

            <div class="mt-6 pt-5 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeDeleteModal()" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:ring-opacity-50 transition-colors">
                    Cancel
                </button>
                <form id="deleteForm" method="POST" class="inline">
                    <input type="hidden" id="delete_transaction_id" name="transaction_id" />
                    <button type="submit" class="px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-colors">Confirm Deletion</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    // Edit modal
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const editTransactionId = document.getElementById("edit_transaction_id");

    // Delete modal
    const deleteModal = document.getElementById("deleteModal");
    const deleteForm = document.getElementById("deleteForm");
    const deleteTransactionId = document.getElementById("delete_transaction_id");

    // Filter modal
    const filterModal = document.getElementById("filterModal");
    const filterBtn = document.getElementById("filter-btn");
    const activeFilters = document.getElementById("active-filters");
    const dateFilterBadge = document.getElementById("date-filter-badge");
    const typeFilterBadge = document.getElementById("type-filter-badge");

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get("start_date");
    const endDate = urlParams.get("end_date");
    const transactionType = urlParams.get("type");

    // Initialize page, set current filter state
    document.addEventListener("DOMContentLoaded", function () {
        // Set date filter value
        if (startDate) {
            document.getElementById("start_date").value = startDate;
        }
        if (endDate) {
            document.getElementById("end_date").value = endDate;
        }

        // Show current filter state
        updateFilterBadges();

        // Set transaction type filter button state
        if (transactionType) {
            setTransactionTypeButtonState(transactionType);
        }
    });

    // Toggle filter modal display/hide
    function toggleFilterModal() {
        filterModal.classList.toggle("hidden");
    }

    // Apply date filter
    function applyDateFilter() {
        const startDate = document.getElementById("start_date").value;
        const endDate = document.getElementById("end_date").value;

        if (startDate && !endDate) {
            alert("Please select end date");
            return;
        }

        if (!startDate && endDate) {
            alert("Please select start date");
            return;
        }

        if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
            alert("Start date cannot be later than end date");
            return;
        }

        // Build query parameters
        const params = new URLSearchParams(window.location.search);

        if (startDate) params.set("start_date", startDate);
        else params.delete("start_date");

        if (endDate) params.set("end_date", endDate);
        else params.delete("end_date");

        // Reset page number
        params.set("page", "1");

        // Redirect to filtered URL
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    // Clear date filter
    function clearDateFilter() {
        document.getElementById("start_date").value = "";
        document.getElementById("end_date").value = "";
    }

    // Transaction type filter
    function filterTransactionType(type) {
        const params = new URLSearchParams(window.location.search);

        if (type === "all") {
            params.delete("type");
        } else {
            params.set("type", type);
        }

        // Reset page number
        params.set("page", "1");

        // Redirect to filtered URL
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    // Set transaction type button state
    function setTransactionTypeButtonState(type) {
        // Reset all buttons
        document.getElementById("filter-all").classList.remove("bg-primary", "text-white");
        document.getElementById("filter-all").classList.add("bg-gray-100", "text-gray-700", "hover:bg-gray-200");

        document.getElementById("filter-expense").classList.remove("bg-primary", "text-white");
        document.getElementById("filter-expense").classList.add("bg-gray-100", "text-gray-700", "hover:bg-gray-200");

        document.getElementById("filter-income").classList.remove("bg-primary", "text-white");
        document.getElementById("filter-income").classList.add("bg-gray-100", "text-gray-700", "hover:bg-gray-200");

        // Set selected button
        const buttonId = type === "all" ? "filter-all" : type === "expense" ? "filter-expense" : type === "income" ? "filter-income" : "filter-all";

        document.getElementById(buttonId).classList.remove("bg-gray-100", "text-gray-700", "hover:bg-gray-200");
        document.getElementById(buttonId).classList.add("bg-primary", "text-white");
    }

    // Update filter identifier
    function updateFilterBadges() {
        let hasDateFilters = false;
        let hasTypeFilters = false;

        // Check date filter
        if (startDate && endDate) {
            const formattedStartDate = formatDate(startDate);
            const formattedEndDate = formatDate(endDate);
            dateFilterBadge.textContent = `${formattedStartDate} to ${formattedEndDate}`;
            dateFilterBadge.classList.remove("hidden");
            hasDateFilters = true;
        } else {
            dateFilterBadge.classList.add("hidden");
        }

        // Check type filter
        if (transactionType) {
            typeFilterBadge.textContent = transactionType === "expense" ? "Only Expenses" : "Only Income";
            typeFilterBadge.classList.remove("hidden");
            hasTypeFilters = true;
        } else {
            typeFilterBadge.classList.add("hidden");
        }

        // Show or hide filter area
        if (hasDateFilters || hasTypeFilters) {
            activeFilters.classList.remove("hidden");
        } else {
            activeFilters.classList.add("hidden");
        }

        // Only highlight date filter button when date filter is active
        if (hasDateFilters) {
            filterBtn.classList.add("bg-primary", "text-white");
            filterBtn.classList.remove("bg-gray-100", "text-gray-700");
        } else {
            filterBtn.classList.remove("bg-primary", "text-white");
            filterBtn.classList.add("bg-gray-100", "text-gray-700");
        }
    }

    // Format date in a more friendly format
    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getMonth() + 1}æ${date.getDate()}æ¥`;
    }

    // Clear all filters
    function clearAllFilters() {
        window.location.href = window.location.pathname;
    }

    // Open edit modal and load data
    async function openEditModal(id) {
        editTransactionId.value = id;
        editForm.action = `/flow/${id}/edit`;

        try {
            // Get transaction record data
            const response = await fetch(`/flow/${id}/data`);
            if (!response.ok) throw new Error("Failed to get data");

            const data = await response.json();

            // Fill form data
            document.querySelector('input[name="amount"]').value = data.amount;
            document.querySelector('input[name="date"]').value = data.date;
            document.querySelector('input[name="description"]').value = data.description || "";

            // Set transaction type radio buttons
            const typeRadios = document.querySelectorAll('input[name="type"]');
            for (let radio of typeRadios) {
                radio.checked = radio.value === data.type;
            }

            // Load corresponding type category options
            await loadCategories(data.type, data.category_id);

            // Show modal
            editModal.classList.remove("hidden");
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to load data, please try again");
        }
    }

    // Close edit modal
    function closeEditModal() {
        editModal.classList.add("hidden");
        editForm.reset();
    }

    // Load category options
    async function loadCategories(type, selectedId) {
        try {
            const response = await fetch(`/flow/categories/${type}`);
            if (!response.ok) throw new Error("Failed to get categories");

            const categories = await response.json();
            const selectElement = document.querySelector('select[name="category_id"]');

            // Clear existing options
            selectElement.innerHTML = '<option value="">Select Category</option>';

            // Add category options
            categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category.id;
                option.textContent = category.name;
                option.selected = category.id === selectedId;
                selectElement.appendChild(option);
            });
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to load categories, please try again");
        }
    }

    // Category change reload category
    document.querySelectorAll('input[name="type"]').forEach((radio) => {
        radio.addEventListener("change", function () {
            if (this.checked) {
                loadCategories(this.value);
            }
        });
    });

    // Open delete confirmation modal
    function confirmDelete(id) {
        deleteTransactionId.value = id;
        deleteForm.action = `/flow/${id}/delete`;
        deleteModal.classList.remove("hidden");
    }

    // Close delete confirmation modal
    function closeDeleteModal() {
        deleteModal.classList.add("hidden");
    }

    // Submit form processing
    editForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        try {
            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
            });

            const result = await response.json();

            if (result.success) {
                window.location.reload(); // Reload page on success
            } else {
                alert(result.message || "Operation failed, please try again");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Submission failed, please try again");
        }
    });

    // Delete form processing
    deleteForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        try {
            const response = await fetch(this.action, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
            });

            const result = await response.json();

            if (result.success) {
                window.location.reload(); // Reload page on success
            } else {
                alert(result.message || "Deletion failed, please try again");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Deletion failed, please try again");
        }
    });
</script>
{% endblock %}
